<template>
  <ItemsListing
    itemtype="artists"
    :items="items"
    :show-provider="false"
    :show-favorites-only-filter="true"
    :load-data="loadItems"
    :show-album-artists-only-filter="true"
    :update-available="updateAvailable"
  />
</template>

<script setup lang="ts">
import { onBeforeUnmount, onMounted, ref } from 'vue';
import { useI18n } from 'vue-i18n';
import ItemsListing from '../components/ItemsListing.vue';
import api from '../plugins/api';
import { MediaType, type Artist, EventMessage, EventType, MediaItemType } from '../plugins/api/interfaces';
import { store } from '../plugins/store';

const { t } = useI18n();
const items = ref<Artist[]>([]);
const updateAvailable = ref(false);

const loadItems = async function (
  offset: number,
  limit: number,
  sort: string,
  search?: string,
  favoritesOnly = true,
  albumArtistsOnly = true,
) {
  const favorite = favoritesOnly || undefined;
  updateAvailable.value = false;
  return await api.getLibraryArtists(favorite, search, limit, offset, sort, albumArtistsOnly);
};

store.topBarContextMenuItems = [
  {
    label: 'sync_now',
    labelArgs: [t('artists')],
    action: () => {
      api.startSync([MediaType.ARTIST]);
    },
    icon: 'mdi-sync',
  },
];
onBeforeUnmount(() => {
  store.topBarContextMenuItems = [];
});

onMounted(() => {
  // signal if/when items get added/updated/removed within this library
  const unsub = api.subscribe_multi(
    [EventType.MEDIA_ITEM_ADDED, EventType.MEDIA_ITEM_UPDATED, EventType.MEDIA_ITEM_DELETED],
    (evt: EventMessage) => {
      // signal user that there might be updated info available for this item
      if (evt.object_id?.startsWith('library://artist')) {
        updateAvailable.value = true;
      }
    },
  );
  onBeforeUnmount(unsub);
});
</script>
